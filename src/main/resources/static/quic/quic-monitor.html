<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUICè¿æ¥ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #333;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336, #FF5722);
        }

        .status-healthy {
            color: #4CAF50;
        }

        .status-warning {
            color: #FF9800;
        }

        .status-critical {
            color: #f44336;
        }

        .connections-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .connection-id {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .active-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .active {
            background: #4CAF50;
        }

        .inactive {
            background: #9E9E9E;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #5a67d8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        .recommendations {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .recommendations ul {
            margin-left: 20px;
        }

        .recommendations li {
            margin: 5px 0;
            color: #1565C0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .connections-table {
                padding: 10px;
            }
            
            th, td {
                padding: 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span class="status-indicator" id="globalStatus"></span>
                QUICè¿æ¥ç›‘æ§ç³»ç»Ÿ
            </h1>
            <p style="color: #666; margin-top: 10px;">å®æ—¶ç›‘æ§QUICè¿æ¥æµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶å’Œæ€§èƒ½æŒ‡æ ‡</p>
        </header>

        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

        <div class="dashboard">
            <!-- å…¨å±€ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸŒ å…¨å±€ç»Ÿè®¡</h2>
                <div class="metric">
                    <span class="metric-label">æ´»è·ƒè¿æ¥æ•°</span>
                    <span class="metric-value" id="activeConnections">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»åˆ›å»ºè¿æ¥æ•°</span>
                    <span class="metric-value" id="totalConnectionsCreated">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">è¿è¡Œæ—¶é—´</span>
                    <span class="metric-value" id="uptime">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ç³»ç»ŸçŠ¶æ€</span>
                    <span class="metric-value" id="systemStatus">-</span>
                </div>
            </div>

            <!-- æµé‡ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸ“Š æµé‡ç»Ÿè®¡</h2>
                <div class="metric">
                    <span class="metric-label">æ€»å‘é€æ•°æ®</span>
                    <span class="metric-value" id="totalBytesSent">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»æ¥æ”¶æ•°æ®</span>
                    <span class="metric-value" id="totalBytesReceived">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å‘é€é€Ÿç‡</span>
                    <span class="metric-value" id="sendRate">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ¥æ”¶é€Ÿç‡</span>
                    <span class="metric-value" id="receiveRate">-</span>
                </div>
            </div>

            <!-- å…¨å±€æµé‡åˆ©ç”¨ç‡ -->
            <div class="card">
                <h2>ğŸ“ˆ å…¨å±€æµé‡åˆ©ç”¨ç‡</h2>
                <div class="metric">
                    <span class="metric-label">å½“å‰åˆ©ç”¨ç‡</span>
                    <span class="metric-value" id="globalUtilization">-</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="utilizationProgress" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">åœ¨é€”å­—èŠ‚æ•°</span>
                    <span class="metric-value" id="bytesInFlight">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å³°å€¼åœ¨é€”å­—èŠ‚</span>
                    <span class="metric-value" id="peakBytesInFlight">-</span>
                </div>
            </div>

            <!-- æ€§èƒ½æŒ‡æ ‡å¡ç‰‡ -->
            <div class="card">
                <h2>âš¡ æ€§èƒ½æŒ‡æ ‡</h2>
                <div class="metric">
                    <span class="metric-label">å¹³å‡å‘é€é€Ÿç‡</span>
                    <span class="metric-value" id="avgSendRate">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å¹³å‡æ¥æ”¶é€Ÿç‡</span>
                    <span class="metric-value" id="avgReceiveRate">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»ä¼ è¾“æ•°æ®</span>
                    <span class="metric-value" id="totalDataTransferred">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">è¿æ¥æˆåŠŸç‡</span>
                    <span class="metric-value" id="connectionSuccessRate">-</span>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€å»ºè®® -->
        <div class="card" id="healthRecommendations" style="display: none;">
            <h2>ğŸ’¡ ç³»ç»Ÿå»ºè®®</h2>
            <div id="recommendationsList"></div>
        </div>

        <!-- è¿æ¥è¯¦æƒ…è¡¨æ ¼ -->
        <div class="connections-table">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ“‹ è¿æ¥è¯¦æƒ…</h2>
            <table id="connectionsTable">
                <thead>
                    <tr>
                        <th>è¿æ¥ID</th>
                        <th>çŠ¶æ€</th>
                        <th>å‘é€çª—å£åˆ©ç”¨ç‡</th>
                        <th>æ¥æ”¶çª—å£åˆ©ç”¨ç‡</th>
                        <th>åœ¨é€”å­—èŠ‚</th>
                        <th>å‘é€é€Ÿç‡</th>
                        <th>æ¥æ”¶é€Ÿç‡</th>
                        <th>ç©ºé—²æ—¶é—´</th>
                        <th>æ€»å‘é€</th>
                        <th>æ€»æ¥æ”¶</th>
                    </tr>
                </thead>
                <tbody id="connectionsBody">
                    <tr>
                        <td colspan="10" class="loading">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            startAutoRefresh();
        });

        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–é€Ÿç‡
        function formatRate(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                const remainingHours = hours % 24;
                return `${days}å¤© ${remainingHours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
            } else if (hours > 0) {
                return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ ${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        // æ ¼å¼åŒ–ç©ºé—²æ—¶é—´
        function formatIdleTime(idleTime) {
            if (idleTime < 60000) {
                return Math.floor(idleTime / 1000) + ' ç§’';
            } else if (idleTime < 3600000) {
                return Math.floor(idleTime / 60000) + ' åˆ†é’Ÿ';
            } else {
                return Math.floor(idleTime / 3600000) + ' å°æ—¶';
            }
        }

        // æ›´æ–°å…¨å±€ç»Ÿè®¡
        function updateGlobalStats(data) {
            document.getElementById('activeConnections').textContent = data.activeConnections || 0;
            document.getElementById('totalConnectionsCreated').textContent = data.totalConnectionsCreated || 0;
            document.getElementById('uptime').textContent = formatUptime(data.uptimeSeconds || 0);
            
            document.getElementById('totalBytesSent').textContent = formatBytes(data.totalBytesSent || 0);
            document.getElementById('totalBytesReceived').textContent = formatBytes(data.totalBytesReceived || 0);
            document.getElementById('sendRate').textContent = formatRate(data.globalSendRate || 0);
            document.getElementById('receiveRate').textContent = formatRate(data.globalReceiveRate || 0);
            
            const utilization = data.globalUtilization || 0;
            document.getElementById('globalUtilization').textContent = utilization.toFixed(2) + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.getElementById('utilizationProgress');
            progressBar.style.width = utilization + '%';
            progressBar.className = 'progress-fill';
            if (utilization > 90) {
                progressBar.classList.add('danger');
            } else if (utilization > 70) {
                progressBar.classList.add('warning');
            }
            
            document.getElementById('bytesInFlight').textContent = formatBytes(data.globalBytesInFlight || 0);
            document.getElementById('peakBytesInFlight').textContent = formatBytes(data.peakBytesInFlight || 0);
        }

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        function updatePerformanceMetrics(data) {
            document.getElementById('avgSendRate').textContent = formatRate(Math.round((data.averageSendRateMBps || 0) * 1024 * 1024));
            document.getElementById('avgReceiveRate').textContent = formatRate(Math.round((data.averageReceiveRateMBps || 0) * 1024 * 1024));
            document.getElementById('totalDataTransferred').textContent = (data.totalDataTransferredMB || 0).toFixed(2) + ' MB';
            document.getElementById('connectionSuccessRate').textContent = (data.connectionSuccessRate || 0).toFixed(2) + '%';
        }

        // æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€
        function updateSystemHealth(data) {
            const statusElement = document.getElementById('systemStatus');
            const statusIndicator = document.getElementById('globalStatus');
            
            statusElement.textContent = data.status || 'UNKNOWN';
            statusElement.className = 'metric-value';
            
            statusIndicator.className = 'status-indicator';
            switch(data.status) {
                case 'HEALTHY':
                    statusElement.classList.add('status-healthy');
                    statusIndicator.style.background = '#4CAF50';
                    break;
                case 'WARNING':
                    statusElement.classList.add('status-warning');
                    statusIndicator.style.background = '#FF9800';
                    break;
                case 'CRITICAL':
                    statusElement.classList.add('status-critical');
                    statusIndicator.style.background = '#f44336';
                    break;
                default:
                    statusIndicator.style.background = '#9E9E9E';
            }
            
            // æ›´æ–°å»ºè®®
            if (data.recommendations && data.recommendations.length > 0) {
                const recommendationsDiv = document.getElementById('healthRecommendations');
                const recommendationsList = document.getElementById('recommendationsList');
                
                recommendationsList.innerHTML = '<ul>' + 
                    data.recommendations.map(rec => `<li>${rec}</li>`).join('') + 
                    '</ul>';
                recommendationsDiv.style.display = 'block';
            } else {
                document.getElementById('healthRecommendations').style.display = 'none';
            }
        }

        // æ›´æ–°è¿æ¥è¡¨æ ¼
        function updateConnectionsTable(connections) {
            const tbody = document.getElementById('connectionsBody');
            
            if (!connections || connections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">æš‚æ— è¿æ¥æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = connections.map(conn => `
                <tr>
                    <td><span class="connection-id">${conn.connectionId}</span></td>
                    <td>
                        <span class="active-indicator ${conn.active ? 'active' : 'inactive'}"></span>
                        ${conn.active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                    </td>
                    <td>
                        <div class="progress-bar" style="width: 100px; height: 10px;">
                            <div class="progress-fill ${conn.sendWindowUtilization > 80 ? 'danger' : conn.sendWindowUtilization > 60 ? 'warning' : ''}" 
                                 style="width: ${conn.sendWindowUtilization}%"></div>
                        </div>
                        ${conn.sendWindowUtilization}%
                    </td>
                    <td>
                        <div class="progress-bar" style="width: 100px; height: 10px;">
                            <div class="progress-fill ${conn.receiveWindowUtilization > 80 ? 'danger' : conn.receiveWindowUtilization > 60 ? 'warning' : ''}" 
                                 style="width: ${conn.receiveWindowUtilization}%"></div>
                        </div>
                        ${conn.receiveWindowUtilization}%
                    </td>
                    <td>${formatBytes(conn.bytesInFlight || 0)}</td>
                    <td>${formatRate(conn.sendRate || 0)}</td>
                    <td>${formatRate(conn.receiveRate || 0)}</td>
                    <td>${formatIdleTime(conn.idleTime || 0)}</td>
                    <td>${formatBytes(conn.totalBytesSent || 0)}</td>
                    <td>${formatBytes(conn.totalBytesReceived || 0)}</td>
                </tr>
            `).join('');
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
                const [globalStats, performanceMetrics, systemHealth, connections] = await Promise.all([
                    fetch('/api/quic/global/stats').then(r => r.json()),
                    fetch('/api/quic/performance/metrics').then(r => r.json()),
                    fetch('/api/quic/health').then(r => r.json()),
                    fetch('/api/quic/connections').then(r => r.json())
                ]);

                updateGlobalStats(globalStats);
                updatePerformanceMetrics(performanceMetrics);
                updateSystemHealth(systemHealth);
                updateConnectionsTable(connections);

            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡çŠ¶æ€');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.refresh-btn'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(refreshData, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // é¡µé¢éšè—æ—¶åœæ­¢åˆ·æ–°ï¼Œæ˜¾ç¤ºæ—¶æ¢å¤
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                refreshData();
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>