<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUICå®æ—¶ä»ªè¡¨ç›˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0099ff;
            display: block;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #999;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-good { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .status-critical { color: #f44336; }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336, #FF5722);
        }

        .refresh-info {
            text-align: center;
            margin: 20px 0;
            color: #999;
        }

        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 10px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ QUICå®æ—¶ä»ªè¡¨ç›˜</h1>
            <div class="refresh-info">
                <span class="real-time-indicator"></span>
                <span>å®æ—¶æ•°æ® - æ¯3ç§’è‡ªåŠ¨åˆ·æ–°</span>
            </div>
        </header>

        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title">ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</div>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-value" id="activeConnections">0</span>
                        <div class="metric-label">æ´»è·ƒè¿æ¥</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="globalUtilization">0%</span>
                        <div class="metric-label">å…¨å±€åˆ©ç”¨ç‡</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="sendRate">0</span>
                        <div class="metric-label">å‘é€é€Ÿç‡(MB/s)</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="receiveRate">0</span>
                        <div class="metric-label">æ¥æ”¶é€Ÿç‡(MB/s)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ’¾ æ•°æ®ä¼ è¾“</div>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-value" id="totalSent">0</span>
                        <div class="metric-label">æ€»å‘é€(GB)</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="totalReceived">0</span>
                        <div class="metric-label">æ€»æ¥æ”¶(GB)</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="bytesInFlight">0</span>
                        <div class="metric-label">åœ¨é€”å­—èŠ‚(GB)</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="peakThroughput">0</span>
                        <div class="metric-label">å³°å€¼åå(GB)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">âš¡ ç³»ç»ŸçŠ¶æ€</div>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-value" id="systemStatus" class="status-good">å¥åº·</span>
                        <div class="metric-label">ç³»ç»ŸçŠ¶æ€</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="uptime">0h</span>
                        <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="totalConnections">0</span>
                        <div class="metric-label">æ€»è¿æ¥æ•°</div>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="successRate">100%</span>
                        <div class="metric-label">æˆåŠŸç‡</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµé‡åˆ©ç”¨ç‡å›¾è¡¨ -->
        <div class="chart-container full-width">
            <canvas id="utilizationChart"></canvas>
        </div>

        <!-- è¿æ¥è¯¦æƒ…è¡¨ -->
        <div class="table-container">
            <div class="card-title">ğŸ“‹ è¿æ¥è¯¦æƒ… (Top 10)</div>
            <table id="connectionsTable">
                <thead>
                    <tr>
                        <th>è¿æ¥ID</th>
                        <th>çŠ¶æ€</th>
                        <th>å‘é€çª—å£</th>
                        <th>æ¥æ”¶çª—å£</th>
                        <th>åœ¨é€”å­—èŠ‚</th>
                        <th>å‘é€é€Ÿç‡</th>
                        <th>æ¥æ”¶é€Ÿç‡</th>
                        <th>ç©ºé—²æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="connectionsBody">
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666;">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let utilizationChart;
        let utilizationData = [];
        const MAX_DATA_POINTS = 20;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('utilizationChart').getContext('2d');
            utilizationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å…¨å±€æµé‡åˆ©ç”¨ç‡ (%)',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ ¼å¼åŒ–æ•°å€¼
        function formatGB(bytes) {
            return (bytes / (1024 * 1024 * 1024)).toFixed(2);
        }

        function formatMB(bytes) {
            return (bytes / (1024 * 1024)).toFixed(1);
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            if (hours >= 24) {
                const days = Math.floor(hours / 24);
                const remainingHours = hours % 24;
                return `${days}d ${remainingHours}h`;
            }
            return `${hours}h`;
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart(utilization) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            if (utilizationChart.data.labels.length >= MAX_DATA_POINTS) {
                utilizationChart.data.labels.shift();
                utilizationChart.data.datasets[0].data.shift();
            }
            
            utilizationChart.data.labels.push(timeLabel);
            utilizationChart.data.datasets[0].data.push(utilization);
            utilizationChart.update();
        }

        // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
        function updateMetrics(globalStats, performanceMetrics) {
            document.getElementById('activeConnections').textContent = globalStats.activeConnections || 0;
            document.getElementById('globalUtilization').textContent = (globalStats.globalUtilization || 0).toFixed(1) + '%';
            document.getElementById('sendRate').textContent = formatMB(globalStats.globalSendRate || 0);
            document.getElementById('receiveRate').textContent = formatMB(globalStats.globalReceiveRate || 0);
            
            document.getElementById('totalSent').textContent = formatGB(globalStats.totalBytesSent || 0);
            document.getElementById('totalReceived').textContent = formatGB(globalStats.totalBytesReceived || 0);
            document.getElementById('bytesInFlight').textContent = formatGB(globalStats.globalBytesInFlight || 0);
            document.getElementById('peakThroughput').textContent = formatGB(globalStats.peakBytesInFlight || 0);
            
            document.getElementById('uptime').textContent = formatUptime(globalStats.uptimeSeconds || 0);
            document.getElementById('totalConnections').textContent = globalStats.totalConnectionsCreated || 0;
            document.getElementById('successRate').textContent = (performanceMetrics.connectionSuccessRate || 100).toFixed(1) + '%';
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(status) {
            const element = document.getElementById('systemStatus');
            element.textContent = status;
            element.className = 'metric-value';
            
            switch(status) {
                case 'HEALTHY':
                    element.classList.add('status-good');
                    break;
                case 'WARNING':
                    element.classList.add('status-warning');
                    break;
                case 'CRITICAL':
                    element.classList.add('status-critical');
                    break;
                default:
                    element.classList.add('status-good');
            }
        }

        // æ›´æ–°è¿æ¥è¡¨
        function updateConnectionsTable(connections) {
            const tbody = document.getElementById('connectionsBody');
            
            if (!connections || connections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">æš‚æ— è¿æ¥</td></tr>';
                return;
            }

            // åªæ˜¾ç¤ºå‰10ä¸ªè¿æ¥
            const topConnections = connections.slice(0, 10);
            
            tbody.innerHTML = topConnections.map(conn => {
                const activeClass = conn.active ? 'status-good' : 'status-warning';
                const sendProgressClass = conn.sendWindowUtilization > 80 ? 'danger' : conn.sendWindowUtilization > 60 ? 'warning' : '';
                const receiveProgressClass = conn.receiveWindowUtilization > 80 ? 'danger' : conn.receiveWindowUtilization > 60 ? 'warning' : '';
                
                return `
                    <tr>
                        <td style="font-family: monospace;">${conn.connectionId}</td>
                        <td><span class="${activeClass}">${conn.active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</span></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${sendProgressClass}" style="width: ${conn.sendWindowUtilization}%"></div>
                            </div>
                            ${conn.sendWindowUtilization}%
                        </td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${receiveProgressClass}" style="width: ${conn.receiveWindowUtilization}%"></div>
                            </div>
                            ${conn.receiveWindowUtilization}%
                        </td>
                        <td>${formatMB(conn.bytesInFlight || 0)}</td>
                        <td>${formatMB(conn.sendRate || 0)}</td>
                        <td>${formatMB(conn.receiveRate || 0)}</td>
                        <td>${Math.floor((conn.idleTime || 0) / 1000)}s</td>
                    </tr>
                `;
            }).join('');
        }

        // ä¸»åˆ·æ–°å‡½æ•°
        async function refreshDashboard() {
            try {
                const [globalStats, performanceMetrics, systemHealth, connections] = await Promise.all([
                    fetch('/api/quic/global/stats').then(r => r.json()),
                    fetch('/api/quic/performance/metrics').then(r => r.json()),
                    fetch('/api/quic/health').then(r => r.json()),
                    fetch('/api/quic/connections').then(r => r.json())
                ]);

                updateMetrics(globalStats, performanceMetrics);
                updateSystemStatus(systemHealth.status);
                updateConnectionsTable(connections);
                updateChart(globalStats.globalUtilization || 0);

            } catch (error) {
                console.error('åˆ·æ–°ä»ªè¡¨ç›˜å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            refreshDashboard();
            
            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(refreshDashboard, 3000);
        });
    </script>
</body>
</html>